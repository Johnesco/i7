# IF Hub — Deployment & Architecture Guide

IF Hub is a static site that serves multiple Inform 7 games through a unified browser interface with source viewer, walkthrough viewer, and centralized sound controls.

**Live site**: Deployed to GitHub Pages from this directory.
**Local preview**: `bash deploy.sh && python -m http.server 8000`

---

## Table of Contents

- [Directory Structure](#directory-structure)
- [How It Works](#how-it-works)
- [Game Registry (games.json)](#game-registry-gamesjson)
- [Deployment (deploy.sh)](#deployment-deploysh)
- [Sound System](#sound-system)
- [Adding a New Game](#adding-a-new-game)
- [Adding Sound to a Game](#adding-sound-to-a-game)
- [File Reference](#file-reference)

---

## Directory Structure

```
ifhub/
├── README.md                ← This file
├── CLAUDE.md                ← AI assistant instructions
│
├── index.html               ← Landing page (game cards, descriptions, links)
├── app.html                 ← Main player UI (game selector, source viewer, sound controls)
├── play.html                ← Shared Parchment player (loaded in iframe by app.html)
├── play-template.html       ← Template for standalone per-game play pages
├── sound-standalone.html    ← Sound script block injected into standalone play pages
├── importing.html           ← Documentation/import page
│
├── games.json               ← Game registry — all game metadata in one place
├── deploy.sh                ← Asset deployment script — copies from projects/ into games/
│
├── lib/
│   └── parchment/           ← Shared Parchment interpreter libraries
│       ├── jquery.min.js    ← DOM library
│       ├── main.js          ← Parchment game loader
│       ├── main.css         ← Layout styling
│       ├── parchment.js     ← Engine variant
│       ├── parchment.css    ← Engine styling
│       ├── quixe.js         ← Quixe interpreter (JS Glulx)
│       └── glulxe.js        ← Glulxe interpreter (WASM Glulx)
│
└── games/                   ← Per-game assets (populated by deploy.sh)
    └── <game-id>/
        ├── index.html       ← Standalone play page (generated by deploy.sh)
        ├── story.ni         ← Source code (copied from project)
        ├── <game>.ulx.js    ← Base64-encoded game binary
        ├── walkthrough.*    ← Walkthrough files (if available)
        ├── lib/             ← Sound scripts (if sound-enabled)
        │   ├── ambient-audio.js   ← Room-based ambient loops (optional)
        │   ├── sound-engine.js    ← Shared sound effects engine
        │   └── sound-config.js    ← Game-specific trigger definitions
        └── audio/           ← Audio files (if sound-enabled)
            ├── *.mp3        ← Ambient zone loops
            └── sfx/*.mp3    ← One-shot sound effects
```

### Current Games

| Game ID | Title | Sound | Source |
|---------|-------|-------|--------|
| `zork1-v0` | Zork I (v0 — Original ZIL) | No | `projects/zork1/versions/v0/` |
| `zork1-v1` | Zork I (v1 — The Port) | No | `projects/zork1/versions/v1/` |
| `zork1-v2` | Zork I (v2 — Bug Fixes) | No | `projects/zork1/versions/v2/` |
| `zork1-v3` | Zork I (v3 — Current) | Yes | `projects/zork1/versions/v3/` + `projects/zork1/web/` |
| `dracula` | Dracula's Castle | No | `projects/dracula/` |
| `feverdream` | Fever Dream | Yes | `projects/feverdream/` |
| `sample` | Sample | No | `projects/sample/` |

---

## How It Works

IF Hub has two ways to play games:

### 1. Main Hub (app.html)

`app.html` is the full-featured interface:
- **Game selector dropdown** — switches between all registered games
- **Source viewer tab** — displays the game's `story.ni` with syntax highlighting
- **Walkthrough viewer tab** — shows walkthrough guides (if available)
- **Centralized sound controls** — mute button + volume slider (visible only for sound-enabled games)
- **Game player** — an iframe that loads `play.html` with the selected game's binary

The iframe communication flow for sound:
```
app.html                          play.html (iframe)
   │                                  │
   │  ?binary=X&soundBase=games/Y     │
   ├─────────────────────────────────►│
   │                                  │  loads ambient-audio.js
   │                                  │  loads sound-engine.js
   │                                  │  loads sound-config.js
   │     ifhub:soundReady             │
   │◄─────────────────────────────────┤
   │  (show sound controls)           │
   │                                  │
   │  ifhub:setMute { muted: true }   │
   ├─────────────────────────────────►│  → ifhubAmbient.setMuted()
   │                                  │  → ifhubSfx.setMuted()
   │                                  │
   │  ifhub:setVolume { volume: 0.7 } │
   ├─────────────────────────────────►│  → ifhubAmbient.setMasterVolume()
   │                                  │  → ifhubSfx.setMasterVolume()
```

### 2. Standalone Play Pages (games/\<id\>/index.html)

Each game also gets a standalone `index.html` generated by `deploy.sh` from `play-template.html`. These work independently — no app.html needed. For sound-enabled games, the `sound-standalone.html` block is injected, which sets `window.SOUND_AUDIO_BASE = "./"` and loads the sound scripts directly.

### Shared Parchment Library

All games share the same Parchment interpreter files from `lib/parchment/`. Standalone play pages reference them via `../../lib/parchment/`. The iframe-based `play.html` uses a relative `lib_path`. This means there's exactly one copy of the interpreter — no per-game duplication.

Game binaries (`.ulx.js`) are the only per-game Parchment artifact. They are base64-encoded Glulx binaries wrapped in a JSONP callback: `processBase64Zcode('BASE64...')`.

---

## Game Registry (games.json)

Every game must have an entry in `games.json`. This file drives:
- The game selector in `app.html`
- The landing page cards in `index.html`
- Standalone play page generation in `deploy.sh`
- Sound control visibility (the `"sound": true` flag)

### Schema

```json
{
  "id": "mygame",
  "title": "My Game",
  "sourceLabel": "mygame.ni",
  "source": "games/mygame/story.ni",
  "binary": "games/mygame/mygame.ulx.js",
  "walkthrough": "games/mygame/walkthrough.html",
  "sound": true,
  "sourceBrowser": false,
  "versionLabel": "v1 — Description",
  "card": {
    "title": "My Game",
    "meta": "A Subtitle",
    "description": "HTML description for the landing page card.",
    "versions": ["mygame-v0", "mygame-v1"]
  }
}
```

| Field | Required | Description |
|-------|----------|-------------|
| `id` | Yes | Unique identifier. Must match the `games/<id>/` directory name. |
| `title` | Yes | Display name in the game selector dropdown. |
| `sourceLabel` | Yes | Label for the source viewer tab. |
| `source` | Yes | Path to source file (relative to ifhub root). |
| `binary` | Yes | Path to base64-encoded game binary. |
| `walkthrough` | No | Path to walkthrough HTML page. Enables the walkthrough tab. |
| `sound` | No | Set to `true` to enable sound. Shows controls in app.html, injects scripts in standalone pages. |
| `sourceBrowser` | No | Set to `true` if source is an HTML page (loaded in iframe instead of fetched as text). |
| `versionLabel` | No | Shown in the game selector for versioned games (e.g., "v1 — The Port"). |
| `card` | No | Landing page card. Games without a card don't appear on the landing page. |
| `card.versions` | No | Array of game IDs grouped under this card (for versioned games like Zork1). |

---

## Deployment (deploy.sh)

`deploy.sh` is a bash script that copies assets from each project's source directory into the `games/` directory. It also generates standalone `index.html` play pages.

### What It Does

For each game defined in the `GAMES` array:

1. **Copies source** — `story.ni` from the project directory
2. **Copies binary** — `.ulx.js` or `.z3.js` compiled game file
3. **Copies walkthroughs** (if in `WALKTHROUGH_DIRS`) — `walkthrough.html`, `walkthrough.txt`, `walkthrough-guide.txt`, `walkthrough_output.txt`
4. **Copies sound assets** (if in `SOUND_DIRS`) — `lib/ambient-audio.js`, `lib/sound-engine.js`, `lib/sound-config.js`, and the entire `audio/` directory
5. **Generates standalone play pages** — `index.html` from `play-template.html`, with sound scripts injected for sound-enabled games

### Configuration

The script has three configuration sections:

#### GAMES array
Maps game IDs to source and binary paths (relative to the ifhub root):

```bash
GAMES=(
  "sample      projects/sample/story.ni          projects/sample/web/lib/parchment/sample.ulx.js"
  "feverdream  projects/feverdream/story.ni       projects/feverdream/web/lib/parchment/feverdream.ulx.js"
  "zork1-v3    projects/zork1/versions/v3/story.ni  projects/zork1/versions/v3/lib/parchment/zork1.ulx.js"
)
```

Use `none` as the source path for games without Inform 7 source (e.g., the ZIL-compiled v0).

#### WALKTHROUGH_DIRS
Maps game IDs to directories containing walkthrough files:

```bash
declare -A WALKTHROUGH_DIRS
WALKTHROUGH_DIRS=(
  [sample]="projects/sample/web"
  [zork1-v3]="projects/zork1/versions/v3"
)
```

#### SOUND_DIRS
Maps game IDs to directories containing sound assets:

```bash
declare -A SOUND_DIRS
SOUND_DIRS=(
  [zork1-v3]="projects/zork1/web"
  [feverdream]="projects/feverdream/web"
)
```

The script looks for these files within each sound directory:
- `lib/ambient-audio.js` — room-based ambient audio (optional, warns if missing)
- `lib/sound-engine.js` — shared sound effects engine (required for sound games)
- `lib/sound-config.js` — game-specific trigger definitions (required for sound games)
- `audio/` — directory of audio files (required for sound games)

### Running

```bash
cd ifhub/
bash deploy.sh
```

Output shows what was copied, with warnings for missing files. Missing optional files (like `ambient-audio.js` for games without ambient audio) produce warnings but don't cause failures.

### Standalone Play Page Generation

After copying assets, `deploy.sh` runs an inline Python script that:
1. Reads `games.json` for the game list
2. Reads `play-template.html` for the page template
3. Reads `sound-standalone.html` for the sound script block
4. For each game with a `games/<id>/` directory:
   - Replaces `__TITLE__` with the game title
   - Replaces `__BINARY__` with the binary filename
   - Replaces `__SOUND_SCRIPTS__` with the sound block (if `"sound": true`) or empty string
   - Writes `games/<id>/index.html`

---

## Sound System

### Architecture Overview

Sound in IF Hub uses a JavaScript overlay that watches the game's DOM output for triggers and plays audio in response. There are two types of triggers:

| Type | How It Works | Best For |
|------|-------------|----------|
| **Style_user1** | Game emits `[first custom style]` in `story.ni` via the Glulx Text Effects extension. GlkOte renders this as `<span class="Style_user1">`. The engine parses `SFX:<id>` commands from the span text. CSS hides the span from the player. | Precise, author-controlled triggers at exact narrative moments |
| **Text matching** | Regex patterns matched against game output text as it appears in the DOM. | Ambient sounds, incidental effects triggered by prose |

Both types can coexist in the same game.

### Sound Scripts

Sound-enabled games have up to three scripts in their `lib/` directory:

| Script | Source of Truth | Purpose |
|--------|----------------|---------|
| `sound-engine.js` | `tools/web/sound-engine.js` | Shared engine — MutationObserver, audio playback, ifhub integration, mute button. Copied to each game. |
| `sound-config.js` | Per-game (e.g., `projects/feverdream/web/lib/sound-config.js`) | Game-specific triggers — the only file that differs between games. |
| `ambient-audio.js` | Per-game (e.g., `projects/zork1/web/lib/ambient-audio.js`) | Room-based ambient audio loops with crossfading. Optional — only Zork1 v3 uses this currently. |

### sound-engine.js API

The engine exposes a single initialization function:

```javascript
SoundEngine.init({
  storageKey: 'mygame-audio-muted',

  // Style_user1 triggers (precise, from story.ni)
  sfx: {
    glass: { src: 'audio/sfx/glass.mp3', volume: 0.4 }
  },

  // Text-matching triggers (regex against game output)
  textTriggers: [
    { id: 'bird', pattern: /chirping of a song bird/i,
      src: 'audio/sfx/bird.mp3', volume: 0.25, cooldownMs: 10000 }
  ]
});
```

| Config Field | Type | Description |
|-------------|------|-------------|
| `storageKey` | string | localStorage key for mute state (standalone mode only) |
| `sfx` | object | Map of `id → { src, volume }` for Style_user1 commands |
| `textTriggers` | array | Array of `{ id, pattern, src, volume, cooldownMs }` for text matching |

### ifhub Integration

When loaded inside app.html's iframe, `play.html` sets `window.SOUND_AUDIO_BASE` before loading the sound scripts. This puts both `sound-engine.js` and `ambient-audio.js` into **ifhub mode**:

- Audio file paths are prefixed with `SOUND_AUDIO_BASE`
- The local mute button is hidden (app.html's controls take over)
- `window.ifhubSfx` API is exposed: `setMuted(bool)`, `setMasterVolume(0-1)`
- `window.ifhubAmbient` API is exposed (same methods, for ambient-audio.js)
- Sound state is persisted in app.html via `localStorage` keys `ifhub-audio-muted` and `ifhub-audio-volume`

In **standalone mode** (no `SOUND_AUDIO_BASE`), each game shows its own mute button and persists state via its own `storageKey`.

### Style_user1 in story.ni

To use precise sound triggers from Inform 7 source:

```inform7
Include Glulx Text Effects by Emily Short.

To issue sound command (T - text):
    say "[first custom style][T][roman type]".

Instead of opening the coffin:
    issue sound command "SFX:coffin-creak";
    say "The lid groans open."
```

And in the game's CSS (play.html or play-template.html):
```css
.Style_user1 { display: none; }
```

The `[first custom style]` substitution maps to Glk's `style_User1`, which GlkOte/AsyncGlk renders as `<span class="Style_user1">`. The CSS hides it before it renders (no flash). The MutationObserver catches it regardless.

---

## Adding a New Game

### Prerequisites

The game must already be compiled and have a web player set up in its project directory. See `C:\code\ifhub\CLAUDE.md` for compiler paths and `tools/web/setup-web.sh` for web player setup.

### Steps

1. **Add to `GAMES` array in `deploy.sh`**:
   ```bash
   "mygame  projects/mygame/story.ni  projects/mygame/web/lib/parchment/mygame.ulx.js"
   ```

2. **Add to `games.json`** with at minimum:
   ```json
   {
     "id": "mygame",
     "title": "My Game",
     "sourceLabel": "mygame.ni",
     "source": "games/mygame/story.ni",
     "binary": "games/mygame/mygame.ulx.js",
     "card": {
       "title": "My Game",
       "meta": "A Subtitle",
       "description": "Description for the landing page."
     }
   }
   ```

3. **Optionally add walkthroughs** — add to `WALKTHROUGH_DIRS` in `deploy.sh`

4. **Run deploy**: `bash deploy.sh`

5. **Commit and push** — the `games/<id>/` directory and updated config files

---

## Adding Sound to a Game

### Prerequisites

- The shared sound engine exists at `tools/web/sound-engine.js`
- Audio files (MP3, CC0-licensed recommended) are ready

### Steps

1. **Copy sound engine to project**:
   ```bash
   cp tools/web/sound-engine.js projects/mygame/web/lib/
   # Or use: bash tools/web/setup-web.sh --sound ...
   ```

2. **Create `sound-config.js`** in the project's `web/lib/`:
   ```javascript
   SoundEngine.init({
     storageKey: 'mygame-audio-muted',
     sfx: {
       // Style_user1 triggers (if using Glulx Text Effects)
       explosion: { src: 'audio/sfx/explosion.mp3', volume: 0.4 }
     },
     textTriggers: [
       // Text-matching triggers (regex)
       { id: 'door', pattern: /door creaks open/i,
         src: 'audio/sfx/creak.mp3', volume: 0.3, cooldownMs: 5000 }
     ]
   });
   ```

3. **Add audio files** to `projects/mygame/web/audio/sfx/`

4. **Update play.html** — add CSS hide rule and script tags:
   ```css
   .Style_user1 { display: none; }
   ```
   ```html
   <script src="lib/sound-engine.js"></script>
   <script src="lib/sound-config.js"></script>
   ```

5. **If using Style_user1** — add to `story.ni`:
   ```inform7
   Include Glulx Text Effects by Emily Short.

   To issue sound command (T - text):
       say "[first custom style][T][roman type]".
   ```

6. **Wire into ifhub** — in `ifhub/`:
   - Add `"sound": true` to the game's entry in `games.json`
   - Add the game to `SOUND_DIRS` in `deploy.sh`
   - Run `bash deploy.sh`

7. **Commit and push** both the project repo and the ifhub repo

---

## File Reference

### Hub-Level Files

| File | Purpose | When to Edit |
|------|---------|-------------|
| `index.html` | Landing page with game cards | Adding/removing games from the landing page |
| `app.html` | Main player UI with game selector, source viewer, sound controls | Changing the player UI, adding features |
| `play.html` | Parchment player loaded in iframe by app.html | Changing how games load, updating sound script loading |
| `play-template.html` | Template for standalone play pages | Changing the standalone player appearance or behavior |
| `sound-standalone.html` | Sound script block injected into standalone pages | Changing which scripts standalone pages load |
| `games.json` | Game registry | Adding/removing games, enabling sound |
| `deploy.sh` | Asset deployment | Adding games, changing source paths, adding walkthroughs/sound |

### Per-Game Files (games/\<id\>/)

| File | Copied From | Purpose |
|------|-------------|---------|
| `index.html` | Generated from `play-template.html` | Standalone play page |
| `story.ni` | Project's `story.ni` | Source code for source viewer |
| `*.ulx.js` / `*.z3.js` | Project's compiled binary | Game data for Parchment |
| `walkthrough.html` | Project's walkthrough dir | Walkthrough viewer page |
| `walkthrough.txt` | Project's walkthrough dir | Raw walkthrough commands |
| `walkthrough-guide.txt` | Project's walkthrough dir | Annotated walkthrough |
| `walkthrough_output.txt` | Project's walkthrough dir | Transcript of walkthrough run |
| `lib/sound-engine.js` | `tools/web/sound-engine.js` (via project) | Shared sound engine |
| `lib/sound-config.js` | Project's `web/lib/sound-config.js` | Game-specific sound triggers |
| `lib/ambient-audio.js` | Project's `web/lib/ambient-audio.js` | Room-based ambient audio |
| `audio/*.mp3` | Project's `web/audio/` | Audio files |

### Shared Parchment Library (lib/parchment/)

All 7 files are required. See `C:\code\ifhub\CLAUDE.md` for details on each file's role and what happens if it's missing.

### Source of Truth

| What | Authoritative Location | Copied To |
|------|----------------------|-----------|
| Parchment interpreter | `ifhub/lib/parchment/` | Referenced in-place (not copied) |
| Sound engine | `tools/web/sound-engine.js` | Each project's `web/lib/`, then `games/<id>/lib/` |
| Game source | `projects/<game>/story.ni` | `games/<id>/story.ni` |
| Game binary | `projects/<game>/web/lib/parchment/<game>.ulx.js` | `games/<id>/<game>.ulx.js` |
| Sound config | `projects/<game>/web/lib/sound-config.js` | `games/<id>/lib/sound-config.js` |
| Audio files | `projects/<game>/web/audio/` | `games/<id>/audio/` |
| Game metadata | `games.json` | Read by app.html, index.html, deploy.sh |
